#include "reg24le1.h" //Defini��es de muitos endere�os de registradores.
#include "stdint.h" //inteiros uint8_t, int8_t, uint16_t....
#include "stdbool.h" //Booleanos
#include "API.h"
#include "nRF-SPIComands.h"


//Subendere�os usados no sistema
#define MY_SUB_ADDR 0x01
#define OTHER_SUB_ADDR 0x02
// pacote = [sub_endere�o_destinatario] QWH	QWL	QXH	QXL	QYH	QYL	QZH	QZL	AXH	AXL	AYH	AYL	AZH	AZL GXH	GXL	GYH	GYL	GZH	GZL	MXH	MXL	MYH	MYL	MZH	MZL
uint8_t pacote[27];
uint8_t pacotes[] = {
	19,7,255,140,0,27,194,229,0,0,0,0,255,254,3,216,255,123,31,33,0,102,0,131,0,175,
	19,5,255,134,0,24,194,228,0,0,0,0,255,254,3,214,255,121,31,41,0,101,0,132,0,175,
	19,3,255,127,0,22,194,228,0,0,0,0,255,254,3,213,255,118,31,44,0,101,0,132,0,175,
	19,1,255,121,0,20,194,227,0,0,0,0,255,254,3,212,255,118,31,44,0,103,0,130,0,175,
	18,255,255,115,0,17,194,227,0,0,0,0,255,254,3,216,255,122,31,41,0,103,0,131,0,175,
	18,252,255,109,0,15,194,226,0,0,0,0,255,254,3,212,255,124,31,42,0,102,0,133,0,175,
	18,250,255,103,0,13,194,225,0,0,0,0,255,254,3,209,255,127,31,37,0,102,0,132,0,175,
	18,248,255,97,0,10,194,225,0,0,0,0,255,254,3,212,255,129,31,39,0,102,0,131,0,174,
	18,194,254,211,255,209,194,210,0,0,0,0,255,254,3,224,255,126,31,44,0,102,0,132,0,175,
	18,192,254,206,255,207,194,210,0,0,0,0,255,254,3,223,255,129,31,34,0,102,0,132,0,175,
	18,190,254,201,255,205,194,209,0,0,0,0,255,254,3,221,255,131,31,43,0,103,0,131,0,175,
	18,188,254,196,255,203,194,208,0,0,255,255,255,254,3,218,255,136,31,48,0,103,0,131,0,175,
	18,185,254,191,255,201,194,208,0,0,0,0,255,254,3,217,255,134,31,52,0,102,0,134,0,176,
	18,183,254,186,255,200,194,207,0,0,0,0,255,254,3,216,255,137,31,56,0,102,0,131,0,175,
	18,181,254,181,255,198,194,207,0,0,0,0,255,254,3,219,255,132,31,47,0,102,0,132,0,175,
	18,179,254,177,255,196,194,206,0,0,0,0,255,254,3,220,255,125,31,43,0,102,0,132,0,176,
	18,177,254,172,255,194,194,206,0,0,0,0,255,254,3,220,255,123,31,37,0,102,0,132,0,174,
	18,175,254,167,255,192,194,205,0,0,0,0,255,254,3,218,255,124,31,36,0,102,0,130,0,175,
	18,173,254,162,255,191,194,205,0,0,0,0,255,254,3,219,255,129,31,27,0,101,0,132,0,175,
	18,171,254,158,255,189,194,204,0,0,0,0,255,254,3,217,255,130,31,32,0,101,0,131,0,175,
	18,169,254,153,255,187,194,204,0,0,0,0,255,254,3,216,255,130,31,40,0,102,0,129,0,175,
	18,167,254,149,255,185,194,203,0,0,255,255,255,254,3,214,255,132,31,34,0,102,0,133,0,175,
	18,165,254,145,255,183,194,203,0,0,0,0,255,254,3,212,255,133,31,31,0,101,0,132,0,175,
	18,163,254,140,255,181,194,202,0,0,0,0,255,254,3,213,255,135,31,32,0,103,0,131,0,176,
	18,161,254,136,255,180,194,202,0,0,0,0,255,254,3,215,255,135,31,41,0,101,0,133,0,176,
	18,159,254,131,255,178,194,201,0,0,0,0,255,254,3,214,255,131,31,40,0,102,0,131,0,175,
	18,156,254,127,255,176,194,201,0,0,0,0,255,254,3,218,255,132,31,39,0,102,0,131,0,175,
	18,154,254,123,255,174,194,200,0,0,0,0,255,254,3,213,255,132,31,38,0,101,0,132,0,176,
	18,100,254,22,255,135,194,187,0,0,0,0,255,254,3,219,255,132,31,36,0,102,0,132,0,175,
	18,98,254,18,255,134,194,186,0,0,0,0,255,254,3,222,255,134,31,34,0,102,0,132,0,175,
	18,96,254,15,255,133,194,186,0,0,0,0,255,254,3,221,255,134,31,40,0,102,0,133,0,176,
	18,94,254,11,255,131,194,185,0,0,0,0,255,254,3,222,255,136,31,40,0,102,0,132,0,175,
	18,92,254,8,255,130,194,185,0,0,255,255,255,254,3,223,255,136,31,29,0,102,0,131,0,174,
	18,90,254,4,255,128,194,184,0,0,0,0,255,254,3,226,255,133,31,23,0,102,0,131,0,175,
	18,88,254,1,255,127,194,184,0,0,0,0,255,254,3,230,255,133,31,26,0,102,0,132,0,176,
	18,86,253,253,255,125,194,183,0,0,0,0,255,254,3,227,255,132,31,20,0,102,0,132,0,173,
	18,84,253,250,255,124,194,183,0,0,0,0,255,254,3,227,255,130,31,23,0,103,0,131,0,175,
	18,82,253,246,255,123,194,182,0,0,0,0,255,254,3,224,255,130,31,29,0,102,0,132,0,176,
	18,79,253,243,255,122,194,182,0,0,0,0,255,254,3,221,255,129,31,34,0,101,0,132,0,174,
	18,77,253,240,255,120,194,181,0,0,0,0,255,254,3,222,255,132,31,35,0,104,0,131,0,173,
	18,75,253,237,255,119,194,181,0,0,0,0,255,254,3,220,255,133,31,35,0,102,0,132,0,175,
	18,73,253,234,255,118,194,180,0,0,0,0,255,254,3,222,255,131,31,33,0,102,0,132,0,175,
	18,71,253,230,255,117,194,180,0,0,0,0,255,254,3,221,255,134,31,35,0,103,0,131,0,174,
	18,69,253,228,255,115,194,179,0,0,0,0,255,254,3,219,255,134,31,35,0,102,0,131,0,175,
	18,67,253,224,255,114,194,179,0,0,0,0,255,254,3,221,255,129,31,39,0,102,0,134,0,175,
	18,65,253,221,255,113,194,178,0,0,0,0,255,254,3,223,255,129,31,34,0,101,0,131,0,173,
	18,63,253,218,255,112,194,178,0,0,0,0,255,254,3,223,255,132,31,36,0,103,0,131,0,175,
	18,61,253,215,255,111,194,177,0,0,0,0,255,254,3,222,255,138,31,35,0,100,0,133,0,175,
	18,59,253,212,255,109,194,177,0,0,0,0,255,254,3,221,255,138,31,39,0,102,0,131,0,175,
	18,57,253,209,255,108,194,176,0,0,0,0,255,254,3,222,255,131,31,42,0,103,0,131,0,175,
	18,3,253,138,255,81,194,164,0,0,255,255,255,254,3,217,255,126,31,43,0,103,0,133,0,175,
	18,1,253,135,255,80,194,163,0,0,0,0,255,254,3,219,255,127,31,41,0,103,0,131,0,175,
	17,255,253,133,255,79,194,163,0,0,0,0,255,254,3,222,255,128,31,39,0,102,0,132,0,175,
	17,253,253,130,255,78,194,162,0,0,0,0,255,254,3,222,255,130,31,41,0,102,0,131,0,175,
	17,251,253,128,255,77,194,162,0,0,0,0,255,254,3,219,255,131,31,44,0,101,0,134,0,175,
	17,249,253,126,255,76,194,161,0,0,0,0,255,254,3,213,255,133,31,28,0,103,0,131,0,175,
	17,247,253,123,255,76,194,161,0,0,0,0,255,254,3,215,255,130,31,30,0,102,0,131,0,174,
	17,245,253,121,255,75,194,160,0,0,0,0,255,254,3,217,255,133,31,39,0,101,0,132,0,174,
	17,243,253,119,255,74,194,160,0,0,255,255,255,254,3,215,255,130,31,34,0,102,0,131,0,174,
	17,241,253,116,255,73,194,159,0,0,255,255,255,254,3,218,255,131,31,23,0,103,0,131,0,175,
	17,239,253,114,255,72,194,159,0,0,255,255,255,254,3,221,255,133,31,20,0,101,0,133,0,175,
	17,237,253,112,255,71,194,158,0,0,0,0,255,254,3,219,255,135,31,27,0,102,0,131,0,175,
	17,235,253,109,255,70,194,158,0,0,0,0,255,254,3,221,255,134,31,36,0,102,0,130,0,175,
	17,233,253,107,255,69,194,157,0,0,0,0,255,254,3,220,255,133,31,39,0,102,0,133,0,175,
	17,231,253,105,255,68,194,157,0,0,0,0,255,254,3,223,255,128,31,45,0,101,0,131,0,175,
	17,229,253,102,255,68,194,156,0,0,0,0,255,254,3,219,255,128,31,39,0,101,0,130,0,174,
	17,227,253,100,255,67,194,156,0,0,0,0,255,254,3,219,255,127,31,33,0,101,0,132,0,175,
	17,225,253,98,255,66,194,155,0,0,0,0,255,254,3,216,255,127,31,31,0,102,0,131,0,175,
	17,222,253,96,255,65,194,155,0,0,0,0,255,254,3,215,255,128,31,38,0,103,0,131,0,175,
	17,220,253,94,255,64,194,154,0,0,255,255,255,254,3,212,255,129,31,41,0,101,0,132,0,174,
	17,218,253,92,255,64,194,154,0,0,0,0,255,254,3,214,255,128,31,36,0,102,0,133,0,175,
	17,165,253,42,255,45,194,141,0,0,0,0,255,254,3,219,255,129,31,37,0,103,0,131,0,175,
	17,163,253,40,255,44,194,140,0,0,0,0,255,254,3,220,255,130,31,30,0,102,0,133,0,174,
	17,161,253,39,255,44,194,140,0,0,0,0,255,254,3,216,255,129,31,36,0,101,0,133,0,175,
	17,159,253,37,255,43,194,139,0,0,0,0,255,254,3,218,255,131,31,38,0,102,0,131,0,175,
	17,157,253,35,255,42,194,139,0,0,0,0,255,254,3,215,255,134,31,35,0,102,0,131,0,174,
	17,155,253,34,255,42,194,138,0,0,0,0,255,254,3,212,255,135,31,35,0,101,0,133,0,175,
	17,153,253,32,255,41,194,138,0,0,0,0,255,254,3,211,255,132,31,37,0,103,0,132,0,176,
	17,151,253,31,255,41,194,137,0,0,0,0,255,254,3,212,255,129,31,35,0,103,0,131,0,175,
	17,149,253,29,255,40,194,137,0,0,0,0,255,254,3,217,255,128,31,31,0,102,0,132,0,175,
	17,147,253,27,255,40,194,136,0,0,255,255,255,254,3,218,255,127,31,40,0,101,0,133,0,175,
	17,145,253,25,255,39,194,136,0,0,255,255,255,254,3,221,255,129,31,40,0,103,0,132,0,174,
	17,143,253,24,255,38,194,135,0,0,0,0,255,254,3,222,255,131,31,36,0,103,0,131,0,174
};
// pacote a receber= [sub_endere�o_destinatario] [parar ou iniciar leituras]
#define Sinal_iniciar 0x0A
#define Sinal_parar 0x0B


#define INTERRUPT_TMR0	1

//Defini��es dos bot�es e leds
#define	PIN32
#ifdef 	PIN32
//Pushbuttons
sbit S1  = P0^2;    // 1/0=no/press
sbit S2  = P1^4;    // 1/0=no/press
//LEDS
sbit LED1 = P0^3; // 1/0=light/dark
sbit LED2 = P0^6; // 1/0=light/dark
#endif

void delay_ms(unsigned int x);
void start_T0(void);
void stop_T0(void);
void enviar_pacote_leituras();
void realizar_leituras();

/**************************************************/
// Vari�veis do TMR0
unsigned char NBT0H  = 0x52;			// Este tempo
unsigned char NBT0L  = 0x63;			// equivale a
unsigned char NOVT0  = 0x00;			// Freq. de Amostragem de 30Hz
int timer_flag = 3;
/**************************************************/
void TMR0_IRQ(void) interrupt INTERRUPT_TMR0
{
	if(!NOVT0)
	{
		timer_flag--;
		if(timer_flag <= 0){
			timer_flag = 3;
            realizar_leituras();
            enviar_pacote_leituras();
		}
		TH0= NBT0H;
		TL0= NBT0L;
	}
}
/**************************************************/

void luzes_iniciais(void){
        LED1 = 1; LED2 = 0;
        delay(1000);
        LED1 = 0; LED2 = 1;
        delay(1000);
        LED1 = 1; LED2 = 1;
        delay(1000);
        LED1 = 0; LED2 = 0;
}

void setup(void){
	 // Set up GPIO
    P0DIR = 0xB7;   // 1011 0111 - 1/0 = In/Out - Output: P0.3 e P0.6
    P1DIR = 0xFF;   // Tudo input
    P2DIR = 0xFF;
    P0CON = 0x00;  	// All general I/O
    P1CON = 0x00;  	// All general I/O
    P2CON = 0x00;  	// All general I/O
	// Radio + SPI setup
    RFCE = 0;       // Radio chip enable low
    RFCKEN = 1;     // Radio clk enable
    RF = 1;

    rf_init();
    EA=1; //ativa as interrup��es
	luzes_iniciais();
    RX_Mode();
}
void main(void){
	setup();
	while(1){
		if(newPayload){
			//verifica se o sinal � para mim
			if(rx_buf[0]== MY_SUB_ADDR){
				 switch(rx_buf[1]){
					case Sinal_iniciar:
                        LED1 = 1;
                        start_T0();
						break;
					case Sinal_parar:
                        LED1 = 0;
                        stop_T0();
						break;
				}

			}
			sta = 0;
     		newPayload = 0;
		}
	}
}
/**************************************************/
void delay_ms(unsigned int x)
{
    unsigned int i,j;
    i=0;
    for(i=0;i<x;i++)
    {
       j=508;
           ;
       while(j--);
    }
}
/**************************************************/
/****************TIMER*****************************/
/**************************************************/
//Timer comfigurado para freq de amostragem 30Hz
void start_T0(void)
{
	TMOD=0x31;						// Select Timer 1 --> STOPPED, Timer 0 --> TIMER/16 bits
	TH0= NBT0H;
	TL0= NBT0L;
	ET0=1;								// Active interrupt on Timer 0
	EA=1;									// Active all interrupts
	TR0=1;								// Timer 0 --> RUN
}
/**************************************************/
void stop_T0(void)
{
	TMOD=0x31;						// Select Timer 1 --> STOPPED, Timer 0 --> TIMER/16 bits
	TH0= NBT0H;
	TL0= NBT0L;
	ET0=0;								// Active interrupt on Timer 0
	EA=1;									// Active all interrupts
	TR0=0;								// Timer 0 --> RUN
}
/********************PACOTE******************/
void enviar_pacote_leituras(){
	LED2 = 1;
	for(int i = 1; i<27; i++){
		tx_buf[i] = pacote[i];
	}
	TX_Mode_NOACK(27);
	RX_Mode();
	LED2 = 0;
}
int index_pacote = 0;
void realizar_leituras(){
	pacote[0] = MY_SUB_ADDR; //o pacote sempre começa com o endereço
	for(int i = 0; i<26; i++){ //é preenchido com as 26 leituras
		pacote[i+1] = pacotes[index_pacote+i];
	}
	index_pacote = index_pacote+26;//passa para a proxima linha de pacotes de exemplo
	//TODO: calcular melhor esse numero maximo
	if(index_pacote >= 2000){ //se ta chegando no final recomeça
		index_pacote=0;
	}
}
